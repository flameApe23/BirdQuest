{% extends "base.html" %} {% block title %}{{ group.name }} - BirdQuest{%
endblock %} {% block extra_css %}
<link
    rel="stylesheet"
    href="{{ url_for('static', filename='css/groups.css') }}"
/>
{% endblock %} {% block content %}
<div class="group-detail-page">
    <!-- Group Header -->
    <div class="group-header">
        <a href="{{ url_for('groups') }}" class="back-link">‚Üê Back to Groups</a>
        <div class="group-header-content">
            <div class="group-header-info">
                <h1>{{ group.name }}</h1>
                {% if group.description %}
                <p class="group-description">{{ group.description }}</p>
                {% endif %}
                <div class="group-stats">
                    <span class="stat"
                        >üë§ {{ members|length }} member{% if members|length != 1
                        %}s{% endif %}</span
                    >
                    <span class="stat"
                        >üèÜ {{ active_challenges|length }} active challenge{% if
                        active_challenges|length != 1 %}s{% endif %}</span
                    >
                </div>
            </div>
            <div class="group-header-actions">
                <div class="invite-code-box">
                    <span class="invite-label">Invite Code</span>
                    <span class="invite-code" id="invite-code"
                        >{{ group.invite_code }}</span
                    >
                    <button
                        class="btn-icon"
                        onclick="copyInviteCode()"
                        title="Copy code"
                    >
                        üìã
                    </button>
                </div>
                {% if is_admin %}
                <button
                    class="btn btn-small btn-secondary"
                    onclick="openSettingsModal()"
                >
                    ‚öôÔ∏è Settings
                </button>
                {% endif %}
                <button
                    class="btn btn-small btn-danger"
                    onclick="confirmLeaveGroup()"
                >
                    üö™ Leave
                </button>
            </div>
        </div>
    </div>

    <div class="group-content">
        <!-- Tabs -->
        <div class="group-tabs">
            <button class="tab-btn active" data-tab="leaderboard">
                üèÖ Leaderboard
            </button>
            <button class="tab-btn" data-tab="challenges">üèÜ Challenges</button>
            <button class="tab-btn" data-tab="members">üë• Members</button>
        </div>

        <!-- Leaderboard Tab -->
        <div class="tab-content active" id="leaderboard-tab">
            <div class="leaderboard-container">
                <h2>üèÖ Group Leaderboard</h2>
                <div class="leaderboard-list">
                    {% for member in members %}
                    <div
                        class="leaderboard-item {% if member.id == current_user.id %}current-user{% endif %} {% if loop.index <= 3 %}top-{{ loop.index }}{% endif %}"
                    >
                        <div class="rank">
                            {% if loop.index == 1 %}
                            <span class="rank-badge gold">ü•á</span>
                            {% elif loop.index == 2 %}
                            <span class="rank-badge silver">ü•à</span>
                            {% elif loop.index == 3 %}
                            <span class="rank-badge bronze">ü•â</span>
                            {% else %}
                            <span class="rank-number">#{{ loop.index }}</span>
                            {% endif %}
                        </div>
                        <div class="member-bird">
                            <img
                                src="{{ url_for('static', filename='images/' ~ member.bird.image) }}"
                                alt="{{ member.bird.name }}"
                                class="{% if member.is_shiny %}shiny{% endif %}"
                            />
                        </div>
                        <div class="member-info">
                            <span class="member-name">
                                {{ member.username }} {% if member.is_admin
                                %}<span class="admin-badge">üëë</span>{% endif %}
                                {% if member.id == current_user.id %}<span
                                    class="you-badge"
                                    >(You)</span
                                >{% endif %}
                            </span>
                            <span class="member-bird-name"
                                >{{ member.bird.name }}{% if member.is_shiny %}
                                ‚ú®{% endif %}</span
                            >
                        </div>
                        <div class="member-stats">
                            <span class="stat-item level"
                                >‚≠ê Lv. {{ member.level }}</span
                            >
                            <span class="stat-item streak"
                                >üî• {{ member.streak }} day{% if member.streak
                                != 1 %}s{% endif %}</span
                            >
                            <span class="stat-item seeds"
                                >üå± {{ member.seeds }}</span
                            >
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Challenges Tab -->
        <div class="tab-content" id="challenges-tab">
            <div class="challenges-container">
                <div class="challenges-header">
                    <h2>üèÜ Group Challenges</h2>
                    <button
                        class="btn btn-primary"
                        onclick="openCreateChallengeModal()"
                    >
                        ‚ûï New Challenge
                    </button>
                </div>

                {% if active_challenges %}
                <div class="challenges-section">
                    <h3>Active Challenges</h3>
                    <div class="challenges-grid">
                        {% for challenge in active_challenges %}
                        <div class="challenge-card active">
                            <div class="challenge-header">
                                <h4>{{ challenge.name }}</h4>
                                <span class="challenge-days"
                                    >{{ challenge.days_remaining }} days
                                    left</span
                                >
                            </div>
                            {% if challenge.description %}
                            <p class="challenge-desc">
                                {{ challenge.description }}
                            </p>
                            {% endif %}
                            <div class="challenge-habit">
                                <span class="habit-label">Habit:</span>
                                <span class="habit-name"
                                    >{{ challenge.habit_name }}</span
                                >
                            </div>
                            <div class="challenge-target">
                                <span class="target-label">Target:</span>
                                <span class="target-value"
                                    >{{ challenge.target_count }}
                                    completions</span
                                >
                            </div>
                            <div class="challenge-reward">
                                <span class="reward-label">Reward:</span>
                                <span class="reward-value"
                                    >+{{ challenge.xp_reward }} XP</span
                                >
                            </div>

                            {% if challenge.is_participating %}
                            <div class="user-progress">
                                <div class="progress-bar-container">
                                    <div
                                        class="progress-bar"
                                        style="width: {{ (challenge.user_progress / challenge.target_count * 100)|int }}%"
                                    ></div>
                                </div>
                                <span class="progress-text"
                                    >{{ challenge.user_progress }}/{{
                                    challenge.target_count }}</span
                                >
                            </div>
                            {% if challenge.user_completed %}
                            <div class="completed-badge">‚úÖ Completed!</div>
                            {% else %}
                            <button
                                class="btn btn-small btn-primary"
                                onclick="logChallengeProgress({{ challenge.id }})"
                            >
                                ‚úì Log Today's Progress
                            </button>
                            {% endif %} {% else %}
                            <button
                                class="btn btn-small btn-secondary"
                                onclick="joinChallenge({{ challenge.id }})"
                            >
                                ü§ù Join Challenge
                            </button>
                            {% endif %}

                            <div class="challenge-participants">
                                <span class="participants-label"
                                    >üë• {{ challenge.participant_count }}
                                    participant{% if challenge.participant_count
                                    != 1 %}s{% endif %}</span
                                >
                                {% if challenge.top_participants %}
                                <div class="top-participants">
                                    {% for p in challenge.top_participants[:3]
                                    %}
                                    <span
                                        class="participant {% if p.completed %}completed{% endif %}"
                                    >
                                        {{ p.username }}: {{ p.progress }}/{{
                                        challenge.target_count }}
                                    </span>
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %} {% if past_challenges %}
                <div class="challenges-section past">
                    <h3>Past Challenges</h3>
                    <div class="challenges-grid">
                        {% for challenge in past_challenges %}
                        <div class="challenge-card past">
                            <div class="challenge-header">
                                <h4>{{ challenge.name }}</h4>
                                <span class="challenge-status"
                                    >Ended {{ challenge.end_date }}</span
                                >
                            </div>
                            <div class="challenge-habit">
                                <span class="habit-label">Habit:</span>
                                <span class="habit-name"
                                    >{{ challenge.habit_name }}</span
                                >
                            </div>
                            {% if challenge.is_participating %}
                            <div
                                class="final-result {% if challenge.user_completed %}success{% else %}incomplete{% endif %}"
                            >
                                {% if challenge.user_completed %} ‚úÖ Completed!
                                (+{{ challenge.xp_reward }} XP) {% else %} {{
                                challenge.user_progress }}/{{
                                challenge.target_count }} completed {% endif %}
                            </div>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %} {% if not active_challenges and not past_challenges
                %}
                <div class="empty-state">
                    <div class="empty-icon">üèÜ</div>
                    <h3>No Challenges Yet</h3>
                    <p>Create a challenge to motivate your group!</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Members Tab -->
        <div class="tab-content" id="members-tab">
            <div class="members-container">
                <h2>üë• Group Members</h2>
                <div class="members-list">
                    {% for member in members %}
                    <div class="member-card">
                        <div class="member-bird">
                            <img
                                src="{{ url_for('static', filename='images/' ~ member.bird.image) }}"
                                alt="{{ member.bird.name }}"
                                class="{% if member.is_shiny %}shiny{% endif %}"
                            />
                        </div>
                        <div class="member-details">
                            <span class="member-name">
                                {{ member.username }} {% if member.is_admin
                                %}<span class="admin-badge">üëë Admin</span>{%
                                endif %}
                            </span>
                            <span class="member-level"
                                >Level {{ member.level }}</span
                            >
                        </div>
                        {% if is_admin and member.id != current_user.id %}
                        <div class="member-actions">
                            {% if not member.is_admin %}
                            <button
                                class="btn-icon"
                                onclick="promoteMember({{ member.id }})"
                                title="Promote to admin"
                            >
                                üëë
                            </button>
                            {% endif %}
                            <button
                                class="btn-icon danger"
                                onclick="confirmKickMember({{ member.id }}, '{{ member.username }}')"
                                title="Remove from group"
                            >
                                üö´
                            </button>
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create Challenge Modal -->
<div class="modal" id="create-challenge-modal">
    <div class="modal-backdrop" onclick="closeCreateChallengeModal()"></div>
    <div class="modal-content">
        <div class="modal-header">
            <h2>üèÜ Create New Challenge</h2>
            <button class="modal-close" onclick="closeCreateChallengeModal()">
                √ó
            </button>
        </div>
        <form id="create-challenge-form" onsubmit="createChallenge(event)">
            <div class="form-group">
                <label for="challenge-name">Challenge Name</label>
                <input
                    type="text"
                    id="challenge-name"
                    name="name"
                    placeholder="e.g., 7-Day Study Streak"
                    required
                    maxlength="100"
                />
            </div>
            <div class="form-group">
                <label for="challenge-description"
                    >Description (Optional)</label
                >
                <textarea
                    id="challenge-description"
                    name="description"
                    placeholder="Describe the challenge..."
                    maxlength="500"
                    rows="2"
                ></textarea>
            </div>
            <div class="form-group">
                <label for="challenge-habit">Habit to Track</label>
                <input
                    type="text"
                    id="challenge-habit"
                    name="habit_name"
                    placeholder="e.g., Study for 30 minutes"
                    required
                    maxlength="100"
                />
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="challenge-target">Target Completions</label>
                    <select id="challenge-target" name="target_count">
                        <option value="3">3 times</option>
                        <option value="5">5 times</option>
                        <option value="7" selected>7 times</option>
                        <option value="10">10 times</option>
                        <option value="14">14 times</option>
                        <option value="21">21 times</option>
                        <option value="30">30 times</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="challenge-duration">Duration (Days)</label>
                    <select id="challenge-duration" name="duration_days">
                        <option value="3">3 days</option>
                        <option value="5">5 days</option>
                        <option value="7" selected>7 days</option>
                        <option value="14">14 days</option>
                        <option value="21">21 days</option>
                        <option value="30">30 days</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label for="challenge-reward">XP Reward</label>
                <select id="challenge-reward" name="xp_reward">
                    <option value="25">25 XP (Easy)</option>
                    <option value="50" selected>50 XP (Medium)</option>
                    <option value="75">75 XP (Hard)</option>
                    <option value="100">100 XP (Epic)</option>
                </select>
            </div>
            <div class="modal-actions">
                <button
                    type="button"
                    class="btn btn-secondary"
                    onclick="closeCreateChallengeModal()"
                >
                    Cancel
                </button>
                <button type="submit" class="btn btn-primary">
                    Create Challenge
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Settings Modal -->
<div class="modal" id="settings-modal">
    <div class="modal-backdrop" onclick="closeSettingsModal()"></div>
    <div class="modal-content">
        <div class="modal-header">
            <h2>‚öôÔ∏è Group Settings</h2>
            <button class="modal-close" onclick="closeSettingsModal()">
                √ó
            </button>
        </div>
        <div class="settings-content">
            <div class="invite-code-section">
                <h3>Invite Code</h3>
                <div class="invite-code-display">
                    <span class="invite-code-large"
                        >{{ group.invite_code }}</span
                    >
                    <button
                        class="btn btn-secondary"
                        onclick="copyInviteCode()"
                    >
                        üìã Copy
                    </button>
                </div>
                <p class="settings-hint">
                    Share this code with friends to invite them to the group.
                </p>
            </div>
        </div>
    </div>
</div>

<!-- Toast Container -->
<div class="toast-container" id="toast-container"></div>

{% endblock %} {% block extra_js %}
<script>
    const groupId = {{ group.id }};

    // Tab switching
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            // Remove active from all tabs
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

            // Add active to clicked tab
            this.classList.add('active');
            const tabId = this.dataset.tab + '-tab';
            document.getElementById(tabId).classList.add('active');
        });
    });

    // Modal functions
    function openCreateChallengeModal() {
        document.getElementById('create-challenge-modal').classList.add('active');
    }

    function closeCreateChallengeModal() {
        document.getElementById('create-challenge-modal').classList.remove('active');
        document.getElementById('create-challenge-form').reset();
    }

    function openSettingsModal() {
        document.getElementById('settings-modal').classList.add('active');
    }

    function closeSettingsModal() {
        document.getElementById('settings-modal').classList.remove('active');
    }

    // Copy invite code
    function copyInviteCode() {
        const code = document.getElementById('invite-code').textContent;
        navigator.clipboard.writeText(code).then(() => {
            showToast('Invite code copied!', 'success');
        }).catch(() => {
            showToast('Failed to copy', 'error');
        });
    }

    // Create challenge
    async function createChallenge(event) {
        event.preventDefault();

        const formData = {
            group_id: groupId,
            name: document.getElementById('challenge-name').value.trim(),
            description: document.getElementById('challenge-description').value.trim(),
            habit_name: document.getElementById('challenge-habit').value.trim(),
            target_count: parseInt(document.getElementById('challenge-target').value),
            duration_days: parseInt(document.getElementById('challenge-duration').value),
            xp_reward: parseInt(document.getElementById('challenge-reward').value)
        };

        try {
            const response = await fetch('/api/challenges/create', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData)
            });

            const data = await response.json();

            if (data.success) {
                showToast('Challenge created!', 'success');
                closeCreateChallengeModal();
                setTimeout(() => location.reload(), 1000);
            } else {
                showToast(data.message, 'error');
            }
        } catch (error) {
            showToast('Failed to create challenge', 'error');
        }
    }

    // Join challenge
    async function joinChallenge(challengeId) {
        try {
            const response = await fetch(`/api/challenges/${challengeId}/join`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });

            const data = await response.json();

            if (data.success) {
                showToast(data.message, 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showToast(data.message, 'error');
            }
        } catch (error) {
            showToast('Failed to join challenge', 'error');
        }
    }

    // Log challenge progress
    async function logChallengeProgress(challengeId) {
        try {
            const response = await fetch(`/api/challenges/${challengeId}/log`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });

            const data = await response.json();

            if (data.success) {
                showToast(data.message, 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showToast(data.message, 'error');
            }
        } catch (error) {
            showToast('Failed to log progress', 'error');
        }
    }

    // Leave group
    function confirmLeaveGroup() {
        if (confirm('Are you sure you want to leave this group?')) {
            leaveGroup();
        }
    }

    async function leaveGroup() {
        try {
            const response = await fetch(`/api/groups/${groupId}/leave`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });

            const data = await response.json();

            if (data.success) {
                showToast('Left the group', 'success');
                setTimeout(() => window.location.href = '/groups', 1000);
            } else {
                showToast(data.message, 'error');
            }
        } catch (error) {
            showToast('Failed to leave group', 'error');
        }
    }

    // Promote member
    async function promoteMember(userId) {
        if (!confirm('Promote this member to admin?')) return;

        try {
            const response = await fetch(`/api/groups/${groupId}/promote`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_id: userId })
            });

            const data = await response.json();

            if (data.success) {
                showToast('Member promoted!', 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showToast(data.message, 'error');
            }
        } catch (error) {
            showToast('Failed to promote member', 'error');
        }
    }

    // Kick member
    function confirmKickMember(userId, username) {
        if (confirm(`Remove ${username} from the group?`)) {
            kickMember(userId);
        }
    }

    async function kickMember(userId) {
        try {
            const response = await fetch(`/api/groups/${groupId}/kick`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_id: userId })
            });

            const data = await response.json();

            if (data.success) {
                showToast('Member removed', 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showToast(data.message, 'error');
            }
        } catch (error) {
            showToast('Failed to remove member', 'error');
        }
    }

    // Toast notification
    function showToast(message, type = 'info') {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.innerHTML = `
            <span class="toast-icon">${type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ÑπÔ∏è'}</span>
            <span class="toast-message">${message}</span>
        `;
        container.appendChild(toast);

        setTimeout(() => {
            toast.classList.add('fade-out');
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }

    // Close modals on escape
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeCreateChallengeModal();
            closeSettingsModal();
        }
    });
</script>
{% endblock %}
